# SmartGrader 更新日志

## 版本历史

### v2.1.0 (2026-01-09) - 当前版本

#### ✨ 新功能

##### 1. **语文作文模块**
- **功能亮点**：
  - 支持两种输入方式：
    - 文字输入：直接输入作文主题（如"我的暑假生活"）
    - 图片识别：上传包含作文主题的图片，AI 自动识别主题
  - 年级选择：从小学一年级到高中三年级，共12个年级
  - 作文类型选择：
    - 记叙文：讲述故事和经历
    - 议论文：表达观点和论证
    - 说明文：介绍事物和知识
    - 描写文：描绘景物和人物
    - 应用文：信件、通知等
    - 想象作文：发挥想象力创作
- **智能生成**：
  - AI 根据年级水平自动调整语言难度和字数
  - 根据作文类型生成符合要求的结构和内容
  - 作文内容贴近学生生活，富有真情实感
  - 适当运用修辞手法，使文章生动有趣
- **用户体验**：
  - 精美的UI设计，包含渐变色卡片和图标
  - 一键复制作文内容
  - 支持重新生成作文
  - 提供写作提示，引导学生正确使用AI辅助
- **技术实现**：
  - 新组件：`EssayGenerator` 和 `EssayResult`
  - 服务层新增 `generateEssay` 方法
  - 同时支持 Google Gemini 和阿里通义千问两种AI提供商

---

### v2.0.0 (2026-01-09)

#### 🎯 核心改进

##### 1. **图片上传压缩优化**
- **问题**：之前使用 `browser-image-compression` 库，图片过大导致上传超时和 504 错误
- **解决方案**：
  - 移除外部依赖，使用原生 HTML5 Canvas 压缩
  - 前端压缩：最大 1024px，JPEG 质量 0.7
  - Qwen 后端压缩：最大 800px，JPEG 质量 0.5
  - 切换到更快的 `qwen-vl-plus` 模型
- **效果**：显著减少请求体积，避免超时

##### 2. **AI 语言一致性**
- **问题**：中文试卷批改时，AI 分析混入英文，影响阅读体验
- **解决方案**：
  - 将所有 AI prompt 改为中文指令
  - 明确语言策略：
    - 中文试卷 → 纯中文分析（无英文）
    - 英文试卷 → 英文原文 + 中文注释（如 "derivative (导数)"）
    - 数学试卷 → 中文解释 + 原始公式符号
- **效果**：输出语言与试卷语言完全匹配

##### 3. **错题分析面板**
- **问题**：批改后只显示标注图片，缺少详细的文字分析
- **解决方案**：
  - 在批改图片下方添加错题分析区域
  - 每道错题显示：题号、状态、扣分、错误类型、详细解析
  - 全对时显示祝贺卡片
- **效果**：学生可以清晰看到哪几题错了，以及详细的解题步骤

##### 4. **JSON 解析健壮性**
- **问题**：Qwen 返回的内容可能包含 JSON 之外的说明文字，导致解析失败
- **解决方案**：
  - 改进 JSON 提取逻辑（从第一个 `{` 到最后一个 `}`）
  - 在 prompt 中明确要求只输出 JSON
  - 添加调试日志和更好的错误提示
- **效果**：更稳定的 JSON 解析

---

## 🔧 需要优化的问题

### 高优先级

#### 1. **批改准确性**
- **现状**：AI 批改可能存在误判
- **建议**：
  - 添加人工复核功能
  - 支持手动调整分数和批注
  - 记录批改历史，用于模型微调

#### 2. **边界框定位精度**
- **现状**：题目边界框可能不准确（box_2d 字段）
- **建议**：
  - 集成专业的 OCR 布局分析
  - 支持手动调整边界框
  - 使用更精确的坐标系统

#### 3. **多页试卷处理**
- **现状**：每页独立批改，缺少整体关联
- **建议**：
  - 支持跨页题目识别
  - 整体统计分析（薄弱知识点、错题类型分布）
  - 生成完整的批改报告（PDF/Word）

#### 4. **性能优化**
- **现状**：批改多张图片时，串行处理较慢
- **建议**：
  - 实现并行批改（多页同时处理）
  - 添加进度条显示
  - 支持后台批改，完成后通知

### 中优先级

#### 5. **用户体验**
- **现状**：缺少批改历史记录
- **建议**：
  - 添加本地存储/云端存储
  - 批改历史列表
  - 支持导出批改结果（图片、PDF、JSON）

#### 6. **模型选择**
- **现状**：需要手动切换 Google/Qwen
- **建议**：
  - 自动检测可用性并回退
  - 支持更多模型（Claude, GPT-4V 等）
  - 模型性能对比

#### 7. **题型识别**
- **现状**：未区分选择题、填空题、解答题等
- **建议**：
  - 自动识别题型
  - 针对不同题型使用不同的批改策略
  - 支持客观题自动判分

#### 8. **错题本功能**
- **现状**：只显示当前批改的错题
- **建议**：
  - 错题收集和分类
  - 错题重做功能
  - 知识点关联和推荐

### 低优先级

#### 9. **多语言支持**
- **现状**：界面主要是中文
- **建议**：
  - 支持英文界面
  - 支持更多语言的试卷批改

#### 10. **协作功能**
- **现状**：单用户使用
- **建议**：
  - 教师-学生账号体系
  - 班级管理
  - 批量批改和统计

---

## 📊 技术债务

### 1. **代码结构**
- 将 `app/page.tsx` 拆分为更小的组件
- 提取公共逻辑到 hooks
- 统一错误处理机制

### 2. **类型安全**
- 完善 TypeScript 类型定义
- 减少 `any` 类型的使用
- 添加运行时类型验证（zod）

### 3. **测试**
- 添加单元测试
- 添加集成测试
- 添加 E2E 测试

### 4. **文档**
- 完善 API 文档
- 添加开发者指南
- 添加部署文档

---

## 🚀 部署说明

当前部署在 GitHub Pages：
- 仓库：https://github.com/bullshitAI52/smartgrader
- 访问地址：https://bullshitai52.github.io/smartgrader/

### 部署流程
1. 推送到 `main` 分支
2. GitHub Actions 自动构建
3. 部署到 `gh-pages` 分支
4. 通过 GitHub Pages 访问

---

## 📝 版本对比

### v1.0.0 → v2.0.0 主要变化

| 功能 | v1.0.0 | v2.0.0 |
|------|--------|--------|
| 图片压缩 | browser-image-compression | 原生 Canvas |
| 压缩参数 | 2MB, 1920px, 0.85 | 1024px, 0.7 (前端) / 800px, 0.5 (Qwen) |
| AI Prompt | 英文 | 中文 |
| 语言策略 | 混乱 | 中文纯中文，英文+中文注释 |
| 错题分析 | 无 | 详细卡片式展示 |
| JSON 解析 | 简单正则 | 健壮的首尾提取 |
| Qwen 模型 | qwen-vl-max | qwen-vl-plus |
| 错误处理 | 基础 | 详细日志和提示 |

---

## 🎯 下一步计划

1. **短期（1-2周）**
   - 添加批改历史记录
   - 实现导出功能（PDF）
   - 优化移动端体验

2. **中期（1-2月）**
   - 添加用户账号系统
   - 实现错题本功能
   - 支持更多 AI 模型

3. **长期（3-6月）**
   - 开发教师管理后台
   - 实现班级批量批改
   - 添加数据分析和报表

---

**最后更新**：2026-01-09  
**维护者**：bullshitAI52
